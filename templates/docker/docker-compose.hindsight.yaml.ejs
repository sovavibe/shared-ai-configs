# Docker Compose configuration for Hindsight MCP Server
# Generated by shared-ai-configs
#
# Hindsight is an AI memory server that provides:
# - Long-term memory persistence (recall, retain)
# - Reflection capabilities for complex analysis
# - Multi-session context continuity
#
# Usage:
#   docker-compose -f docker-compose.hindsight.yaml up -d
#
# For more info: https://github.com/hindsight-ai/hindsight
<%
// Configuration defaults
const hindsightConfig = (services?.mcp?.hindsight) || {};
const port = hindsightConfig.port || 8888;
const dataPath = hindsightConfig.data_path || './hindsight-data';
const imageName = hindsightConfig.image || 'hindsight-mcp';
const imageTag = hindsightConfig.tag || 'latest';
const containerName = hindsightConfig.container_name || 'hindsight-alice';
const restartPolicy = hindsightConfig.restart || 'unless-stopped';
const networkName = hindsightConfig.network || 'ai-services';

// Health check configuration
const healthCheck = hindsightConfig.healthcheck || {};
const healthInterval = healthCheck.interval || '30s';
const healthTimeout = healthCheck.timeout || '10s';
const healthRetries = healthCheck.retries || 3;
const healthStartPeriod = healthCheck.start_period || '10s';

// Resource limits (optional)
const resources = hindsightConfig.resources || {};
const memoryLimit = resources.memory_limit;
const cpuLimit = resources.cpu_limit;

// Environment variables
const env = hindsightConfig.env || {};
-%>

version: '3.8'

services:
  hindsight-alice:
    image: <%= imageName %>:<%= imageTag %>
    container_name: <%= containerName %>
    ports:
      - "<%= port %>:8888"
    volumes:
      - <%= dataPath %>:/data
<% if (hindsightConfig.config_path) { -%>
      - <%= hindsightConfig.config_path %>:/app/config:ro
<% } -%>
    environment:
      - HINDSIGHT_DATA_DIR=/data
<% if (env.log_level) { -%>
      - HINDSIGHT_LOG_LEVEL=<%= env.log_level %>
<% } -%>
<% if (env.cors_origins) { -%>
      - HINDSIGHT_CORS_ORIGINS=<%= env.cors_origins %>
<% } -%>
<% if (env.max_memory_items) { -%>
      - HINDSIGHT_MAX_MEMORY_ITEMS=<%= env.max_memory_items %>
<% } -%>
<% Object.entries(env).filter(([k]) => !['log_level', 'cors_origins', 'max_memory_items'].includes(k)).forEach(([key, value]) => { -%>
      - <%= key.toUpperCase() %>=<%= value %>
<% }); -%>
    restart: <%= restartPolicy %>
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/health"]
      interval: <%= healthInterval %>
      timeout: <%= healthTimeout %>
      retries: <%= healthRetries %>
      start_period: <%= healthStartPeriod %>
<% if (memoryLimit || cpuLimit) { -%>
    deploy:
      resources:
        limits:
<% if (memoryLimit) { -%>
          memory: <%= memoryLimit %>
<% } -%>
<% if (cpuLimit) { -%>
          cpus: '<%= cpuLimit %>'
<% } -%>
<% } -%>
    networks:
      - <%= networkName %>
<% if (hindsightConfig.labels) { -%>
    labels:
<% Object.entries(hindsightConfig.labels).forEach(([key, value]) => { -%>
      - "<%= key %>=<%= value %>"
<% }); -%>
<% } -%>

networks:
  <%= networkName %>:
    driver: bridge
<% if (hindsightConfig.external_network) { -%>
    external: true
<% } -%>

volumes:
  hindsight-data:
    driver: local
<% if (hindsightConfig.volume_driver_opts) { -%>
    driver_opts:
<% Object.entries(hindsightConfig.volume_driver_opts).forEach(([key, value]) => { -%>
      <%= key %>: <%= value %>
<% }); -%>
<% } -%>
